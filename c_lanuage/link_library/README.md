# 链接共享库

程序编译和运行时都可能需要一些其代码作为支持,这些提供支持的代码库称为共享库。共享库根据链接时机不同被分为静态共享库和动态共享库。静态共享库与动态共享库都是共享代码的方式。

Linux 系统共享库名字
静态共享库(Static Shared Library)
动态共享库(Dynamic Shared Libary)

## 静态库

静态库就是把目标文件(object file)压缩(archive)到一起,生成 .a 后缀的压缩包

## 动态库

动态库就是把目标文件(object file)链接在一起生成位置独立代码
动态库中还可以再引用他的动态库

## 链接静态库

编译器在编译可执行文件的时候,将可执行文件需要引用的静态库(.a)中的目标文件(object file)提取出来,转移到可执行文件中去,可执行文件在运行时不共享静态库

## 链接动态库

编译时链接动态库: 获取动态库里一些重定位和符号表信息,这些信息可以在程序运行时完成符号地址的计算

运行时链接动态库: 操作系统首先为动态库分配物理内存,然后在进程对应的页表项中建立虚拟页和物理页面之间的映射。操作系统中存在一种引用计数机制,每当一个进程加载了动态库(在该进程的页表中进行一次映射)引用计数+1,当一个进程显式卸载(通过dlclose等)动态库或进程退出时引用计数-1,当减少到0时,系统卸载动态库。动态库加载到进程空间后,链接器根据编译时获取到的动态库信息完成符号虚拟地址的计算。

优点:
1.缩小了可执行文件本身的体积
2.加快了编译速度,节省了系统资源
缺点:
1.只用到了动态库中的部分函数,也需要附带一个相对庞大的动态库
2.如果其他计算机上没有安装对应的动态库,可执行文件就不能加载动态库不能运行

## 链接共享库过程

### 编译时链接

-L  指定共享库查找路径
-l  指定要链接的共享库的名称
可链接静态库也可链接动态库,例如:
gcc -static main.c -o main -L./ -lmymath      在路径 ./ 下链接静态库 libmymath.a
gcc main.c -o main -L./ -lmymath              在路径 ./ 下优先链接动态库 libmymath.so,其次链接静态库 libmymath.a

Linux系统默认的C语言共享库是 /usr/lib/ 下的 libc.so和libc.a,如果用到的C系统函数没在libc.so或libc.a中,需要指定要共享库。
如下:
`# include <math.h>`       需要链接libm.so或libm.a库,  编译时指定要链接的库 -lm
`# include <dlfcn.h>`      需要链接ibdl.so或libdl.a库, 编译时指定要链接的库 -ldl

### 运行时链接

只能链接动态库

#### 1. 在ELF文件 DT_RPATH 指向的目录中查找

编译的时候使用 -Wl,-rpath=./ 指定运行时动态库搜索路径
例如: gcc -Wl,-rpath=./ -o main main.c
运行时动态库查找路径为 ./

#### 2. 环境变量 LD_LIBRARY_PATH 指定的目录

export LD_LIBRARY_PATH=./
运行时动态库查找路径为 ./

#### 3. 系统默认共享库目录

在系统默认的共享库目录里搜寻所需的共享库

#### 4. dlopen dlsym 加载动态库里的函数

不需要指定目录,用代码加载

### Linux系统共享库默认查找目录

/lib/                系统启动时用到的库安装在这个目录中(系统启动时可能还没有挂载/usr/lib)
/usr/lib/            标准库安装的目录
/usr/local/lib/      非标准或实验性的库安装在这个目录中
