# 依赖库

程序编译和运行时都可能需要一些其代码作为支持,这些提供支持的代码库称为共享依赖库。依赖库根据链接时机不同被分为静态链接库和动态链接库。静态链接库与动态链接库都是共享代码的方式。

## 概念介绍

### 静态链接  

静态链接就是编译器在编译可执行文件的时候,将可执行文件需要调用的对应静态链接库(.a)中的目标文件(object file)提取出来,链接到可执行文件中去,使可执行文件在运行的时候不依赖于静态链接库

### 动态链接  

加载动态链接库,首先为动态链接分配物理内存,然后在进程对应的页表项中建立虚拟页和物理页面之间的映射。系统中存在一种引用计数机制,每当一个进程加载了动态库(在该进程的页表中进行一次映射)引用计数+1,当一个进程显式卸载(通过dlclose等)共享库或进程退出时引用计数-1,当减少到0时,系统卸载共享库。
动态编译的可执行文件需要附带一个动态链接库。在执行时,需要调用其对应动态链接库中的代码。所以其优点一方面是缩小了可执行文件本身的体积,另一方面是加快了编译速度,节省了系统资源。缺点一是哪怕是很简单的程序,只用到了链接库中的一两条命令,也需要附带一个相对庞大的链接库;二是如果其他计算机上没有安装对应的运行库,则用动态编译的可执行文件就不能运行。

### 静态链接库

静态链接库就是把目标文件(object file)压缩(archive)到一起,生成 .a 后缀的压缩包

### 动态链接库

动态链接库就是把目标文件(object file)链接在一起生成位置独立代码。

### 静态链接库和动态链接库的区别  

静态链接库中不能再包含其他的动态链接库或者静态库,而在动态链接库中还可以再包含其他的动态或静态链接库

## 链接静态库或动态库过程

### 编译时

既可链接静态库也可链接动态库。按如下次序依次查找,找不到就报错

#### 1. -L<path> -l<name> 所指定的依赖库

-L  指定依赖库查找路径
-l  指定要链接的依赖库的名称
例如:
gcc main.c -o main -L./ -lmymath
在 ./ 目录下链接 libmymath.so或libmymath.a,当目录下同时有静态库和动态库时,优先链接动态库.

Linux系统默认的C语言依赖库是 /usr/lib 下的 libc.so和libc.a,如果用到的C系统函数没有在libc.so或libc.a中,需要指定要链接的库.
如下:
# include <math.h>       需要链接libm.so或libm.a  编译时指定要链接的库 -lm
# include <dlfcn.h>      编译时指定要链接的库 -ldl

#### 2. 系统依赖库默认查找目录

/lib                系统启动时用到的库安装在这个目录中(系统启动时可能还没有挂载/usr/lib)
/usr/lib            标准库安装的目录
/usr/local/lib      非标准或实验性的库安装在这个目录中

### 运行时

只能链接动态库。按如下次序依次查找,找不到就报错

#### 1. 在ELF文件 DT_RPATH 指向的目录中查找

编译的时候使用 -Wl,-rpath=./ 指定
例如:
gcc -Wl,-rpath=./ -o main main.c
指定运行时动态库查找路径为 ./

#### 2. 环境变量 LD_LIBRARY_PATH 指定的目录

export LD_LIBRARY_PATH=./
指定运行时动态库查找路径为 ./

#### 3. 系统依赖库默认查找目录

/lib                系统启动时用到的库安装在这个目录中(系统启动时可能还没有挂载/usr/lib)
/usr/lib            标准库安装的目录
/usr/local/lib      非标准或实验性的库安装在这个目录中
